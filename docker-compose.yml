services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    volumes:
      - ollama:/root/.ollama
      - ./models:/models
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 5s
      timeout: 3s
      retries: 20
  ollama-init:
    image: ollama/ollama:latest
    container_name: ollama-init
    depends_on:
      ollama:
        condition: service_healthy
    environment:
      - OLLAMA_HOST=http://ollama:11434
    volumes:
      - ollama:/root/.ollama
      - ./models:/models:ro
    entrypoint: ["/bin/sh", "-lc", "sh /models/create_model.sh"]
    restart: "no"
  mysql:
    image: mysql:8.0
    container_name: nurse-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: inference_db
      MYSQL_USER: nurse
      MYSQL_PASSWORD: password
    volumes:
      - mysql-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u root -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 3s
      timeout: 3s
      retries: 30
      start_period: 20s

  backend:
    build:
      context: .
      dockerfile: backend.Dockerfile
    container_name: nurse-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./privnurse_gemma3n/backend:/backend
    depends_on:
      mysql:
        condition: service_healthy
      ollama:
        condition: service_healthy
      ollama-init:
        condition: service_completed_successfully
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  frontend:
    build:
      context: .
      dockerfile: frontend.Dockerfile
    container_name: nurse-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./privnurse_gemma3n/frontend:/frontend
      - frontend-node-modules:/frontend/node_modules
      - frontend-build:/frontend/.next
    # command: npm run dev
    depends_on:
      - backend

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cftunnel
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped

volumes:
  ollama:
  mysql-data:
  frontend-node-modules:
  frontend-build:
